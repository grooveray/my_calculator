<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ADMIN</title>
    <style>
      #section__admin div div {
        border-top: 1px solid red;
      }
    </style>
  </head>
  <body>
    <div id="'section__filter">
      <select name="filter" id="select-filter">
        <option value="" selected disabled hidden>Data filtering..</option>
        <option value="all">all</option>
        <option value="company">company</option>
        <option value="feedEfficiency">feedEfficiency</option>
        <option value="day">day</option>
        <option value="productionIndex">productionIndex</option>
        <option value="averageWeight">averageWeight</option>
        <option value="createdAt">createdAt</option>
        <option value="updatedAt">updatedAt</option>
      </select>
    </div>
    <div id="section__admin"></div>

    <script>
      const baseUrl = "https://ray-calculator.herokuapp.com";
      // const baseUrl = "http://localhost:8080";

      let $sectionAdmin = document.getElementById("section__admin");
      const $sectionFilter = document.getElementById("section__filter");
      const $selectFilter = document.getElementById("select-filter");

      let reports = [];

      function transDateStr(string) {
        if (!string) return "-";
        const year = string.substr(0, 4);
        const month = string.substr(5, 2);
        const date = string.substr(8, 2);
        return `${year}/${month}/${date}`;
      }

      function transValue(value, floatNumber) {
        if (!value) return 0;
        return parseFloat(value.toFixed(floatNumber)).toLocaleString("ko-KR");
      }
      async function onClick(index) {
        const id = reports[index].id;
        const isCorrect = prompt("Enter Something", 0);
        if (isCorrect !== "012486")
          return alert("You are Stranger! get out please");
        fetch(`${baseUrl}/calculate/${id}`, {
          method: "DELETE",
        })
          .then(() => {
            window.location.reload();
            return alert("Data Delete Success!");
          })
          .catch(console.error);
      }
      $selectFilter.addEventListener("change", (event) => {
        const selectValue = event.target.value;
        console.log(selectValue);
        // 여기서 중단됨
      });
      async function rendering() {
        fetch(`${baseUrl}/calculate`, {
          method: "GET",
        })
          .then((response) => response.json())
          .then((json) => {
            reports = json.data;
            console.log(reports);
            const containerNode = document.createElement("div");

            for (let i = 0; i < reports.length; i++) {
              const {
                company,
                day,
                inCount,
                outCount,
                averageWeight,
                totalWeight,
                feedAmount,
                upbringingRate,
                feedEfficiency,
                productionIndex,
                createdAt,
                updatedAt,
              } = reports[i];
              const node = document.createElement("div");
              const textNode = document.createTextNode(
                `C:${company},
                D:${transValue(day, 1)},
                IN:${inCount}수,
                OUT:${outCount}수,
                AW:${transValue(averageWeight, 3)}kg,
                TW:${transValue(totalWeight, 1)}kg, 
                FA:${transValue(feedAmount, 2)}kg,
                UR:${transValue(upbringingRate, 1)}%,
                FE:${transValue(feedEfficiency, 3)},
                PI:${transValue(productionIndex, 2)},
                CR:${transDateStr(createdAt)},
                UP:${transDateStr(updatedAt)}`
              );
              node.appendChild(textNode);

              const btnNode = document.createElement("input");
              btnNode.setAttribute("type", "button");
              btnNode.setAttribute("value", "Delete");
              btnNode.setAttribute("onclick", `onClick(${i})`);

              containerNode.append(node, btnNode);
            }

            $sectionAdmin.append(containerNode);
          })
          .catch((err) => console.error(err));
      }
      rendering();
    </script>
  </body>
</html>
